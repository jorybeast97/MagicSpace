# 计算机网络

## TCP

### 为什么需要握手?

因为TCP需要保证一个可靠的传输,所以客户端发送完成后,需要等待服务端回应,而服务端应答完成后才算一个数据安全传输。而在这个过程中,可能会有很多的数据包需要确认,因此需要当前客户端与服务端同步一下二者传输的数据包,也就是说服务器应当知道对哪个数据包进行应答。

因此,握手的主要目的是进行通信两端的同步,包括SYN(序列号),滑动窗口大小等信息。

### 为什么是三次握手?

首先三次握手的过程如下

1. `  client`发送SYN请求同步
2. `  server`确认,并返回自己的SYN和ACK应答码
3. `  client`发送ACK应答确认准备好发送消息

为什么不是两次或者四次？

两次的情况下可能会一个消息在网络中迟滞,同时`  client`重新发送,但是之前迟滞的消息一段时间后又到达了服务器,并被接收。因为第三次握手主要作用用于`  server`确认当前接收到的消息是否是`  client`所发送的消息,这样能够保证过滤到由于网络不稳定导致的延迟消息错误到达服务端的情况。

而四次握手则对于TCP来说意义不大,因为三次握手已经能够满足在不可靠信道上进行可靠传输,但是同样不安全,例如网络断开,掉线等情况,而这类不安全的情况是无法用协议来解决的,所以四次握手对于建立连接阶段意义不大。

### 为什么是四次挥手? 以及wait_time状态的作用?

当TCP连接建立时,就不再区分客户端和服务端,而使用主动端和被动端来区别,而断开TCP的操作双方都可以执行。

第一次挥手：客户端发送一个FIN=M，用来关闭客户端到服务器端的数据传送，客户端进入FIN_WAIT_1状态。意思是说"我客户端没有数据要发给你了"，但是如果你服务器端还有数据没有发送完成，则不必急着关闭连接，可以继续发送数据。

第二次挥手：服务器端收到FIN后，先发送ack=M+1，告诉客户端，你的请求我收到了，但是我还没准备好，请继续你等我的消息。这个时候客户端就进入FIN_WAIT_2 状态，继续等待服务器端的FIN报文,服务端进入CLOSE_WAIT状态。

第三次挥手：当服务器端确定数据已发送完成，则向客户端发送FIN=N报文，告诉客户端，好了，我这边数据发完了，准备好关闭连接了。服务器端进入LAST_ACK状态。

第四次挥手：客户端收到FIN=N报文后，就知道可以关闭连接了，但是他还是不相信网络，怕服务器端不知道要关闭，所以发送ack=N+1后进入TIME_WAIT状态，如果Server端没有收到ACK则可以重传。服务器端收到ACK后，就知道可以断开连接了。客户端等待了2MSL后依然没有收到回复，则证明服务器端已正常关闭，那好，我客户端也可以关闭连接了。最终完成了四次握手。

### TCP和UDP如何选择

TCP ：

1. 字符流协议,传输任意长度消息
2. 传输可靠
3. 流量控制
4. 拥塞控制

UDP : 

1. 一对多通讯
2. 效率高
3. 简单
4. 实时性好,无队头阻塞

### 流量控制

TCP的发送方和接收方由于机器的不同,可能同时能够收到消息的大小也不同,因此需要维护一个窗口用于接收方通知发送方自己还有多少缓冲区可以用于接收信息。

数据可以分为四种 : 

1. 已发送并成功确认的数据
2. 滑动窗口内已发送未确认数据
3. 滑动窗口内未发送的数据
4. 窗口外未发送的数据

### 拥塞控制

拥塞控制主要复习四种算法 : 

1. 慢启动 cwmd从1开始指数增长,到达阈值后转未拥塞避免算法
2. 拥塞避免 : cwmd以线性增长
3. 拥塞发生 ：发生拥塞后,会让阈值变为1/2,然后从新开始触发慢启动
4. 快速恢复 : 当发送端连续收到三个ACK时,说明网络状况还不错,则不会从1开始增长,直接变为cwmd的1/2

## Http协议

### 在地址栏键入URL后发生了什么?

可以从三个方面来答,URL解析过程,网络分层,以及报文格式编码过程。

1. 域名检查,浏览器首先会检查这是一个IP地址,域名还是一个关键字,然后再进行处理
2. 如果是一个域名,会首先进行浏览器内部的缓存检查,如果没有查找到对应的IP，则再去局域网查找,整个域名搜索过程是一个迭代的过程,最后查找到根域名服务器上,然后通过递归的方式返回对应的IP地址。
   1. 根域名服务器
   2. com.前缀域名服务器
   3. 其他域名服务器
3. 构建与IP地址和端口的TCP连接,然后将TCP报文打包为IP,让主机与主机间相互通讯,而后发送到链路层,传输到局域网内。
4. 如果配置了代理此时请求到达Proxy(正向代理),然后代理会检查自身的缓存,去查找目标网址的IP地址,再次经历一次DNS的过程。
5. 到达目标IP后,可能会遇到Gateway(网关&负载均衡),通过反向代理的方式将请求散列到应用服务器上,如tomcat
6. 应用服务器收到url,解析,然后将响应逐层返回
7. 浏览器收到响应,进行页面渲染

以上的部分是对于URL的连接过程,而实际上还有URL的编码过程 ,由于请求一般情况下是`  www.baidu.com`,而浏览器需要把请求转换为Http格式,需要添加head,body等内容。

### Http长连接有哪些优点？

首先,http协议长短连接是通过`connection`字段来区分的,如果是

- `  close` : 如果是服务器收到的Request中,该字段是close,则响应respone后服务器会主动关闭连接
- `  keeplive` : 如果字段值为keeplive,则会保持连接。

那么好处显而易见,能够有效性减少**握手次数**,由于TCP连接建立和断开至少需要7次握手,如果使用短链接,大量请求会导致握手次数过多,影响网络性能,这是最容易理解的。

还有一个重要的点在于,**使用长连接,能够有效减少慢启动的影响**。

> 慢启动算法 : 为了实现拥塞控制,在速率小于拥塞门限阈值时,传输速率以cmwd=1开始,然后每次传输以指数的形态增长
>
> 拥塞避免算法 : 当到达或者超过拥塞门限后,为了防止增长过快导致网络拥塞,则将cmwd的增长次数改为线性增长
>
> 拥塞控制 : 一旦发生了网络拥塞,会将cmwd重置为最小值,然后再从慢启动算法开始增长

如果每次连接都是通过新建一个TCP连接,这样就会导致每一次的连接都需要从慢到快的过程,这样就会导致性能不能够最大化,浪费网络资源。

**长连接缺点**

> 队头阻塞 : TCP协议是字节流协议,需要严格保证传输顺序,如果多个任务1,2,3,4,5按照顺序传输,如果任务1发生丢包,那么即使剩余任务传输到了服务器,也不会被正常接收,需要全部重传

理解了这个概念就能明白长连接带来的一些缺点,由于使用长连接后,我们的请求都是在一个TCP连接中完成的,那么整个过程就是一个串行化过程,多个任务按顺序进入TCP，假如某个头部任务丢包了,就会导致其余所有的任务都需要进行重传,即使各个任务之间没有任何联系。

## TLS/SSL协议

### 如何保证信息安全?

1. PKI证书体系
2. 对称加密算法
3. 密钥交换协议(传输密钥)

